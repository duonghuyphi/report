<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

  </head>
  <body>
  <div class="container" ng-app="reportApp" ng-controller="ReportController">
    <h2>Upload Excel File</h2>
    <div ng-controller="SingleUploadCtrl">
      <form ng-submit="uploadReport()">
        <input type="file" file-model="reportFile" required />
        <button type="submit" class="btn btn-primary"><i class="bi bi-upload"></i> Upload</button>
        <button onclick="location.reload()" class="btn btn-info"><i class="bi bi-arrow-clockwise rotate"></i> Refresh</button>
      </form>
      <pre>{{ result | json }}</pre>
    </div>

    <h2>Xá»­ lÃ½ sáº£n pháº©m combo</h2>
    <button class="btn btn-success mb-3" ng-click="viewProcessedCombo()">ðŸš€ Xá»­ lÃ½ vÃ  hiá»ƒn thá»‹ káº¿t quáº£ Combo</button>


    <h2>Danh sÃ¡ch báº£ng trong CSDL</h2>
    <ul class="list-group">
      <li class="list-group-item d-flex justify-content-between align-items-center"
          ng-repeat="table in tables">
        {{ table }}
        <div>
        <button class="btn btn-sm btn-link" ng-click="viewTable(table)">Xem</button>
        <button class="btn btn-sm btn-link text-danger" ng-click="deleteTable(table)">XÃ³a</button>
        </div>
      </li>
    </ul>

    <hr>

    <div ng-if="tableData.length > 0">
      <h4>Dá»¯ liá»‡u tá»« báº£ng: {{ selectedTable }}</h4>
      <table class="table table-hover">
        <thead>
        <tr>
          <th ng-repeat="col in columns">{{ col }}</th>
        </tr>
        </thead>
        <tbody>
        <tr ng-repeat="row in tableData">
          <td ng-repeat="col in columns">{{ row[col] }}</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>



  <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>

  <script>
    var app = angular.module('reportApp', []);
    var API_BASE_URL = 'https://report-backend.onrender.com';

    app.controller('ReportController', function ($scope, $http) {
      $scope.tables = [];
      $scope.tableData = [];
      $scope.columns = [];
      $scope.selectedTable = '';

      // Load table list
      $http.get(API_BASE_URL+"/tables")
              .then(function (response) {
                $scope.tables = response.data.filter((value, index, self) => {
                  const isDuplicate = self.indexOf(value) !== index;
                  const isSystemTable = value.includes("wp_") || value.includes("pma_");
                  return !isDuplicate && !isSystemTable;
                });
              });

      // Load data of selected table
      $scope.viewTable = function (tableName) {
        $scope.selectedTable = tableName;
        const apiUrl = API_BASE_URL + `/table-data?tableName=${encodeURIComponent(tableName)}`;
        $http.get(apiUrl)
                .then(function (response) {
                  $scope.tableData = response.data;
                  if ($scope.tableData.length > 0) {
                    $scope.columns = Object.keys($scope.tableData[0]);
                  } else {
                    $scope.columns = [];
                  }
                })
                .catch(function (error) {
                  console.error("Lá»—i táº£i dá»¯ liá»‡u báº£ng:", error);
                  alert("KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u báº£ng.");
                });
      };
      $scope.deleteTable = function (tableName) {
        if (!confirm(`Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a báº£ng "${tableName}"?`)) {
          return;
        }

        const apiUrl = API_BASE_URL+`/excel/delete-table?tableName=${encodeURIComponent(tableName)}`;
        $http.delete(apiUrl)
                .then(function (response) {
                  alert("ÄÃ£ xÃ³a báº£ng thÃ nh cÃ´ng.");
                  $scope.selectedTable = null;
                  $scope.tableData = [];
                  $scope.columns = [];
                  // CÃ³ thá»ƒ reload danh sÃ¡ch báº£ng náº¿u báº¡n cÃ³ 1 hÃ m load láº¡i danh sÃ¡ch
                  // $scope.loadAllTables();
                  location.reload();
                })
                .catch(function (error) {
                  console.error("Lá»—i khi xÃ³a báº£ng:", error);
                  alert("KhÃ´ng thá»ƒ xÃ³a báº£ng.");
                });
      };

      $scope.filenameReport = 'report.xlsx';
      $scope.filenameGift = 'gift.xlsx';

      // $scope.loadExpandedData = function () {
      //   const apiUrl = `http://localhost:8080/excel/report-expanded?report=${$scope.filenameReport}&gift=${$scope.filenameGift}`;
      //   $http.get(apiUrl)
      //           .then(function (response) {
      //             $scope.tableData = response.data;
      //             if ($scope.tableData.length > 0) {
      //               $scope.columns = Object.keys($scope.tableData[0]);
      //             }
      //           })
      //           .catch(function (error) {
      //             alert("KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u Ä‘Ã£ xá»­ lÃ½!");
      //             console.error(error);
      //           });
      // };

      $scope.viewProcessedCombo = function () {
        $http.get(API_BASE_URL+"/excel/expand-combo")
                .then(function (response) {
                  $scope.tableData = response.data;
                  $scope.selectedTable = 'Káº¿t quáº£ má»Ÿ rá»™ng Combo';
                  if ($scope.tableData.length > 0) {
                    $scope.columns = Object.keys($scope.tableData[0]);
                  } else {
                    $scope.columns = [];
                  }
                })
                .catch(function (error) {
                  console.error("Lá»—i khi xá»­ lÃ½ combo:", error);
                  alert("KhÃ´ng thá»ƒ xá»­ lÃ½ dá»¯ liá»‡u combo.");
                });
      };
    });

    app.directive('fileModel', ['$parse', function ($parse) {
      return {
        restrict: 'A',
        link: function (scope, element, attrs) {
          const model = $parse(attrs.fileModel);
          const modelSetter = model.assign;

          element.bind('change', function () {
            scope.$apply(function () {
              modelSetter(scope, element[0].files[0]);
            });
          });
        }
      };
    }]);

    app.controller('SingleUploadCtrl', ['$scope', '$http', function ($scope, $http) {
      $scope.uploadReport = function () {
        const formData = new FormData();
        formData.append('file', $scope.reportFile); // ðŸ‘ˆ key lÃ  'file'

        $http.post('/excel/upload', formData, {
          transformRequest: angular.identity,
          headers: { 'Content-Type': undefined }
        }).then(function (response) {
          $scope.result = response.data;
          location.reload();
        }, function () {
          alert('Upload failed');
        });
      };
    }]);


  </script>

  <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    -->
  </body>
</html>
